var F=Object.defineProperty;var N=(r,e,t)=>e in r?F(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var i=(r,e,t)=>(N(r,typeof e!="symbol"?e+"":e,t),t);import{B as C,c as V,d as D,M as g,a as O,S as j,b as G,P as W,H as $,D as Y,e as q,f as H,g as U,h as E,R as X,C as K,F as J,W as Q,s as Z,O as ee,V as f,E as T,i as y,j as te,k as I,r as u,l as v,m as oe,n as A,o as M,p as n,q as R,t as b,u as se,v as S,w as ie,x as ae,y as ne,z as re,A as ce,G as he}from"./vendor.ff64cbae.js";const de=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerpolicy&&(a.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?a.credentials="include":s.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}};de();const P=r=>{const{width:e,height:t}=r,o=Math.min(r.width,r.height),s=a=>{const c=o/a;return[e/c,t/c]};return o>1e3?s(400):o>500?s(160):s(80)};var le="/tattoo/assets/walker.b8a6cdb2.fbx";C.prototype.computeBoundsTree=V;C.prototype.disposeBoundsTree=D;g.prototype.raycast=O;class ue{constructor({container:e,canvas:t,onInitSuccess:o,activeTattooIdChange:s}){i(this,"_container");i(this,"_canvas");i(this,"_state",new j);i(this,"_scene",new G);i(this,"_renderer");i(this,"_camera",new W(45,window.innerWidth/window.innerHeight,1,1e4));i(this,"_hemiLight",new $(16777215,4473924,1));i(this,"_dirLight",new Y(16777215,.3));i(this,"_planeMesh",new g(new q(5e3,5e3),new H({color:10066329,depthWrite:!1})));i(this,"_controls");i(this,"_walkerMesh");i(this,"_tattooInfoMap",new Map);i(this,"_activeTattooId",null);i(this,"_mouseHelper",new g(new U(1,1,180),new E({color:16711680})));i(this,"_raycaster",new X);i(this,"_activeTattooIdChange");i(this,"switchMouseHelperVisible",e=>{e?(this._mouseHelper.visible=!0,this._container.style.cursor="none"):(this._mouseHelper.visible=!1,this._container.style.cursor="inherit")});i(this,"onRemoveTattoo",e=>{const t=this._tattooInfoMap.get(e);t&&(this._scene.remove(t.mesh,t.outlineMesh),this._tattooInfoMap.delete(e),this.activeTattooId=null)});i(this,"init",async()=>{this._scene.background=new K(15329769),this._camera.position.set(-1e3,2e3,3e3),this._hemiLight.position.set(0,3e3,0),this._scene.add(this._hemiLight),this._dirLight.position.set(3e3,3e3,2e3),this._dirLight.castShadow=!0,this._dirLight.shadow.camera.top=2e3,this._dirLight.shadow.camera.bottom=-2e3,this._dirLight.shadow.camera.left=-2e3,this._dirLight.shadow.camera.right=2e3,this._dirLight.shadow.camera.near=.1,this._dirLight.shadow.camera.far=1e4,this._scene.add(this._dirLight),this._planeMesh.rotation.x=-Math.PI/2,this._planeMesh.receiveShadow=!0,this._scene.add(this._planeMesh),this._mouseHelper.visible=!1,this._scene.add(this._mouseHelper);const t=await new J().loadAsync(le);this._scene.add(t),this._walkerMesh=t.children.find(o=>o instanceof g),this._walkerMesh.castShadow=!0,this._walkerMesh.material.color.setHex(16767916),this._walkerMesh.geometry.computeBoundsTree(),this._walkerMesh.geometry.computeVertexNormals(),this._renderer=new Q({canvas:this._canvas,antialias:!0}),this._renderer.shadowMap.enabled=!0,this._renderer.setPixelRatio(window.devicePixelRatio),this._renderer.setSize(this._container.offsetWidth,this._container.offsetHeight),this._renderer.outputEncoding=Z,this._renderer.shadowMap.enabled=!0,this._container.appendChild(this._renderer.domElement),this._raycaster.firstHitOnly=!0,this._controls=new ee(this._camera,this._renderer.domElement),this._controls.target.set(0,1e3,0),this._controls.update(),this._state.dom.style.left="auto",this._state.dom.style.right="0",this._state.dom.style.top="auto",this._state.dom.style.bottom="0",this._container.appendChild(this._state.dom),this.animate()});i(this,"bindEvent",()=>{this._container.addEventListener("pointerdown",e=>{}),this._container.addEventListener("pointermove",this.onPointerMove),this._container.addEventListener("pointerup",e=>{const t=this.getIntersectsByMouseEvent(e);if(this.activeTattooId){const o=t.find(s=>s.object.uuid===this._walkerMesh.uuid);if(!o)return;this.onMoveActiveTattoo(o)}else{const o=this.getPointedTattooIdFromIntersects(t);o&&this.markTattooAsActive(o)}}),window.addEventListener("keyup",e=>{if(e.key==="Escape"){this.clearActiveTattoo();return}e.key==="Backspace"&&this.activeTattooId&&this.onRemoveTattoo(this.activeTattooId)}),window.addEventListener("resize",this.resize)});i(this,"animate",()=>{requestAnimationFrame(this.animate),this._renderer.render(this._scene,this._camera),this._state.update()});i(this,"onPointerMove",e=>{const t=this.getIntersectsByMouseEvent(e),o=t.find(s=>s.object.uuid===this._walkerMesh.uuid);if(o){if(this.switchMouseHelperVisible(!0),this.moveMouseHelper(o),!this.activeTattooId){const s=this.getPointedTattooIdFromIntersects(t);s?this.highLightPointedTattoo(s):this.clearPointedTattooHighLight()}}else this.switchMouseHelperVisible(!1),this.clearPointedTattooHighLight()});i(this,"highLightPointedTattoo",e=>{this._tattooInfoMap.forEach(t=>{t.mesh.uuid===e?(t.outlineMesh.visible=!0,t.outlineMesh.material.color.setHex(8383661)):t.outlineMesh.visible=!1})});i(this,"clearPointedTattooHighLight",()=>{this._tattooInfoMap.forEach(e=>{e.id!==this.activeTattooId&&(e.outlineMesh.visible=!1)})});i(this,"onMoveActiveTattoo",e=>{this.moveMouseHelper(e);const t=this._tattooInfoMap.get(this.activeTattooId),o=t.mesh,s=t.outlineMesh;o.visible=!0,s.visible=!0;const a=new f().copy(e.point),c=new T().copy(this._mouseHelper.rotation),h=new f().copy(t.size);this.updateTattooMesh(t,{position:a,size:h,orientation:c})});i(this,"updateTattooMesh",(e,t={})=>{const o=e.mesh,s=e.outlineMesh,{position:a=e.position,orientation:c=e.orientation,size:h=e.size}=t,l=new y(this._walkerMesh,a,c,h);o.geometry=l;const w=new y(this._walkerMesh,a,c,new f().copy(h));s.geometry=w,e.position=a,e.orientation=c,e.size=h});i(this,"moveMouseHelper",e=>{this._mouseHelper.position.copy(e.point);const t=e.face.normal.clone();t.transformDirection(this._walkerMesh.matrixWorld),t.multiplyScalar(10),t.add(e.point),this._mouseHelper.lookAt(t)});i(this,"getIntersectsByMouseEvent",e=>{const t={x:e.clientX/this._container.offsetWidth*2-1,y:-(e.clientY/this._container.offsetHeight)*2+1};return this._raycaster.setFromCamera(t,this._camera),this._raycaster.intersectObjects(this._scene.children,!0)});i(this,"getPointedTattooIdFromIntersects",e=>{var t,o;return(o=(t=e.find(s=>this._tattooInfoMap.get(s.object.uuid)))==null?void 0:t.object)==null?void 0:o.uuid});i(this,"addTattoo",e=>{const t=e.id,o=new f,s=new T,[a,c]=P(e),h=new f(a,c,200),l=new g(new y(this._walkerMesh,o,s,h),new H({map:new te(e),depthTest:!1}));l.uuid=t,l.visible=!1;const w=new g(new y(this._walkerMesh,o,s,new f().copy(h)),new E({transparent:!0,opacity:.3,depthTest:!1}));this._scene.add(w,l),this._tattooInfoMap.set(e.id,{id:t,canvas:e,mesh:l,outlineMesh:w,size:h,orientation:s,position:o}),this.markTattooAsActive(t)});i(this,"markTattooAsActive",e=>{this.activeTattooId=e,this._tattooInfoMap.get(e).outlineMesh.material.color.setHex(6591981)});i(this,"clearActiveTattoo",()=>{if(this.activeTattooId){const e=this._tattooInfoMap.get(this.activeTattooId);e.outlineMesh.visible=!1,this.activeTattooId=null}});i(this,"rotate",(e,t)=>{const o=this._tattooInfoMap.get(e);if(!o)return null;const s=new T().copy(o.orientation);s.z=t,this.updateTattooMesh(o,{orientation:s})});i(this,"scale",(e,t)=>{const o=this._tattooInfoMap.get(e);if(!o)return null;const[s,a]=P(o.canvas),c=new f(s*t,a*t,200);this.updateTattooMesh(o,{size:c})});i(this,"resize",()=>{this._camera.aspect=this._container.offsetWidth/this._container.offsetHeight,this._camera.updateProjectionMatrix(),this._renderer.setSize(this._container.offsetWidth,this._container.offsetHeight)});i(this,"setSkin",e=>{this._walkerMesh.material.color.setHex(e)});i(this,"lookAt",e=>{this._controls.target.setY(e),this._controls.update()});this._canvas=t,this._container=e,this._activeTattooIdChange=s,this.init().then(()=>{console.log("\u521D\u59CB\u5316\u5B8C\u6210"),this.bindEvent(),o()})}get activeTattooId(){return this._activeTattooId}set activeTattooId(e){this._activeTattooId=e,this._activeTattooIdChange(e)}}const _={tattooViewer:null},pe=I({key:"tattooFilesAtom",default:[]}),B=I({key:"loadingAtom",default:!1}),z=I({key:"editingTattooIdAtom",default:void 0});const me=({info:r})=>{const[e,t]=u.exports.useState(1),o=u.exports.useRef(null),[,s]=v(B),[a]=v(z);u.exports.useEffect(()=>{h()},[]);const c=u.exports.useMemo(()=>oe.exports.debounce(d=>{var m;const p=Math.max(d,.1);(m=_.tattooViewer)==null||m.scale(r.id,p)},300),[r.id]);u.exports.useEffect(()=>{c(e)},[c,e]);const h=()=>{s(!0);const d=o.current,p=d.getContext("2d"),m=new Image,x=new FileReader;x.readAsDataURL(r.file),x.onload=k=>{var L;((L=k.target)==null?void 0:L.readyState)===FileReader.DONE&&(m.src=k.target.result,m.onload=()=>{d.width=m.width,d.height=m.height,p.drawImage(m,0,0),_.tattooViewer.addTattoo(d)}),s(!1)}},l=d=>{var p;(p=_.tattooViewer)==null||p.rotate(r.id,d)},w=A("tattoo-editor-wrapper",{editing:r.id===a});return M("div",{className:w,children:[n("canvas",{className:"tattoo",id:r.id,ref:o}),M("div",{className:"edit-panel",children:[n("div",{children:"\u6587\u4EF6\u540D"}),n("div",{className:"file-name",children:r.file.name}),n("div",{children:"\u65CB\u8F6C"}),n(R,{defaultValue:0,min:-1*Math.PI*10,max:Math.PI*10,onChangeCommitted:(d,p)=>{l(p/10)}}),n("div",{children:"\u5C3A\u5BF8(\u500D\u6570)"}),n(b,{onClick:()=>{const d=e*1e4-.05*1e4;t(d/1e4)},children:n(se,{})}),M("span",{className:"scale-number",children:[" ",e," "]}),n(b,{onClick:()=>{const d=e*1e4+.05*1e4;t(d/1e4)},children:n(S,{})})]})]})};const fe=["fee3d4","ffdbac","f2ccb7","dfaa8b","d19477","bc644d"],_e=()=>{const[r,e]=u.exports.useState("ffdbac");return n("div",{className:"skin-editor",children:fe.map(t=>n("div",{onClick:()=>{var o;e(t),(o=_.tattooViewer)==null||o.setSkin(Number(`0x${t}`))},className:A("color-radio",{active:t===r}),style:{backgroundColor:`#${t}`}},t))})};const we=()=>n("div",{className:"y-slider-wrapper",children:n(R,{onChange:(r,e)=>{var t;(t=_.tattooViewer)==null||t.lookAt(e)},size:"small","aria-label":"Y",orientation:"vertical",defaultValue:1e3,min:0,max:2e3})});function ge(){const r=u.exports.useRef(null),e=u.exports.useRef(null),[t,o]=v(pe),[s,a]=v(B),[,c]=v(z);return u.exports.useEffect(()=>{a(!0),_.tattooViewer=new ue({container:r.current,canvas:e.current,onInitSuccess(){_.tattooViewer.resize(),a(!1)},activeTattooIdChange(h){c(h)}})},[]),M("div",{className:"main-container",children:[n(ie,{open:s,sx:{color:"#fff",zIndex:h=>h.zIndex.drawer+1},children:n(ae,{color:"inherit"})}),t.map(h=>n(me,{info:h},h.id)),n(_e,{}),n(we,{}),M("label",{htmlFor:"upload-input",children:[n("input",{id:"upload-input",type:"file",accept:"image/*",onChange:h=>{const l=h.target.files[0];o([...t,{id:ne(),file:l}])}}),n(b,{className:"add-tattoo",variant:"contained",component:"span",children:n(S,{})})]}),n("div",{className:"canvas-wrapper",ref:r,children:n("canvas",{style:{width:"100%",height:"100%",display:"block"},ref:e})})]})}re.render(n(ce.StrictMode,{children:n(he,{children:n(ge,{})})}),document.getElementById("root"));
