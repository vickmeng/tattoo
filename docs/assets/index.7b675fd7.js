var z=Object.defineProperty;var F=(n,e,t)=>e in n?z(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var i=(n,e,t)=>(F(n,typeof e!="symbol"?e+"":e,t),t);import{B as C,c as N,d as V,M as w,a as D,S as O,b as j,P as G,H as W,D as $,e as q,f as H,g as U,h as E,R as X,C as K,F as Y,W as J,s as Q,O as Z,V as _,E as T,i as y,j as ee,k as I,r as u,l as v,m as te,n as A,o as M,p as r,q as oe,t as b,u as se,v as R,w as ie,x as ae,y as ne,z as re,A as ce,G as he}from"./vendor.ff64cbae.js";const de=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerpolicy&&(a.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?a.credentials="include":s.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}};de();const P=n=>{const{width:e,height:t}=n,o=Math.min(n.width,n.height),s=a=>{const c=o/a;return[e/c,t/c]};return o>1e3?s(400):o>500?s(160):s(80)};var le="/tattoo/assets/walker.b8a6cdb2.fbx";C.prototype.computeBoundsTree=N;C.prototype.disposeBoundsTree=V;w.prototype.raycast=D;class ue{constructor({container:e,canvas:t,onInitSuccess:o,activeTattooIdChange:s}){i(this,"_container");i(this,"_canvas");i(this,"_state",new O);i(this,"_scene",new j);i(this,"_renderer");i(this,"_camera",new G(45,window.innerWidth/window.innerHeight,1,1e4));i(this,"_hemiLight",new W(16777215,4473924,1));i(this,"_dirLight",new $(16777215,.3));i(this,"_planeMesh",new w(new q(5e3,5e3),new H({color:10066329,depthWrite:!1})));i(this,"_controls");i(this,"_walkerMesh");i(this,"_tattooInfoMap",new Map);i(this,"_activeTattooId",null);i(this,"_mouseHelper",new w(new U(1,1,180),new E({color:16711680})));i(this,"_raycaster",new X);i(this,"_activeTattooIdChange");i(this,"switchMouseHelperVisible",e=>{e?(this._mouseHelper.visible=!0,this._container.style.cursor="none"):(this._mouseHelper.visible=!1,this._container.style.cursor="inherit")});i(this,"onRemoveTattoo",e=>{const t=this._tattooInfoMap.get(e);t&&(this._scene.remove(t.mesh,t.outlineMesh),this._tattooInfoMap.delete(e),this.activeTattooId=null)});i(this,"init",async()=>{this._scene.background=new K(15329769),this._camera.position.set(-1e3,2e3,3e3),this._hemiLight.position.set(0,3e3,0),this._scene.add(this._hemiLight),this._dirLight.position.set(3e3,3e3,2e3),this._dirLight.castShadow=!0,this._dirLight.shadow.camera.top=2e3,this._dirLight.shadow.camera.bottom=-2e3,this._dirLight.shadow.camera.left=-2e3,this._dirLight.shadow.camera.right=2e3,this._dirLight.shadow.camera.near=.1,this._dirLight.shadow.camera.far=1e4,this._scene.add(this._dirLight),this._planeMesh.rotation.x=-Math.PI/2,this._planeMesh.receiveShadow=!0,this._scene.add(this._planeMesh),this._mouseHelper.visible=!1,this._scene.add(this._mouseHelper);const t=await new Y().loadAsync(le);this._scene.add(t),this._walkerMesh=t.children.find(o=>o instanceof w),this._walkerMesh.castShadow=!0,this._walkerMesh.material.color.setHex(16767916),this._walkerMesh.geometry.computeBoundsTree(),this._walkerMesh.geometry.computeVertexNormals(),this._renderer=new J({canvas:this._canvas,antialias:!0}),this._renderer.shadowMap.enabled=!0,this._renderer.setPixelRatio(window.devicePixelRatio),this._renderer.setSize(this._container.offsetWidth,this._container.offsetHeight),this._renderer.outputEncoding=Q,this._renderer.shadowMap.enabled=!0,this._container.appendChild(this._renderer.domElement),this._raycaster.firstHitOnly=!0,this._controls=new Z(this._camera,this._renderer.domElement),this._controls.enablePan=!1,this._controls.target.set(0,1e3,0),this._controls.update(),this._state.dom.style.left="auto",this._state.dom.style.right="0",this._state.dom.style.top="auto",this._state.dom.style.bottom="0",this._container.appendChild(this._state.dom),this.animate()});i(this,"bindEvent",()=>{this._container.addEventListener("pointerdown",e=>{}),this._container.addEventListener("pointermove",this.onPointerMove),this._container.addEventListener("pointerup",e=>{const t=this.getIntersectsByMouseEvent(e);if(this.activeTattooId){const o=t.find(s=>s.object.uuid===this._walkerMesh.uuid);if(!o)return;this.onMoveActiveTattoo(o)}else{const o=this.getPointedTattooIdFromIntersects(t);o&&this.markTattooAsActive(o)}}),window.addEventListener("keyup",e=>{if(e.key==="Escape"){this.clearActiveTattoo();return}e.key==="Backspace"&&this.activeTattooId&&this.onRemoveTattoo(this.activeTattooId)}),window.addEventListener("resize",this.resize)});i(this,"animate",()=>{requestAnimationFrame(this.animate),this._renderer.render(this._scene,this._camera),this._state.update()});i(this,"onPointerMove",e=>{const t=this.getIntersectsByMouseEvent(e),o=t.find(s=>s.object.uuid===this._walkerMesh.uuid);if(o){if(this.switchMouseHelperVisible(!0),this.moveMouseHelper(o),!this.activeTattooId){const s=this.getPointedTattooIdFromIntersects(t);s?this.highLightPointedTattoo(s):this.clearPointedTattooHighLight()}}else this.switchMouseHelperVisible(!1),this.clearPointedTattooHighLight()});i(this,"highLightPointedTattoo",e=>{this._tattooInfoMap.forEach(t=>{t.mesh.uuid===e?(t.outlineMesh.visible=!0,t.outlineMesh.material.color.setHex(8383661)):t.outlineMesh.visible=!1})});i(this,"clearPointedTattooHighLight",()=>{this._tattooInfoMap.forEach(e=>{e.id!==this.activeTattooId&&(e.outlineMesh.visible=!1)})});i(this,"onMoveActiveTattoo",e=>{this.moveMouseHelper(e);const t=this._tattooInfoMap.get(this.activeTattooId),o=t.mesh;o.visible=!0;const s=new _().copy(e.point),a=new T().copy(this._mouseHelper.rotation),c=new _().copy(t.size);this.updateTattooMesh(t,{position:s,size:c,orientation:a})});i(this,"updateTattooMesh",(e,t={})=>{const o=e.mesh,s=e.outlineMesh,{position:a=e.position,orientation:c=e.orientation,size:h=e.size}=t,l=new y(this._walkerMesh,a,c,h);o.geometry=l;const f=new y(this._walkerMesh,a,c,new _().copy(h));s.geometry=f,e.position=a,e.orientation=c,e.size=h});i(this,"moveMouseHelper",e=>{this._mouseHelper.position.copy(e.point);const t=e.face.normal.clone();t.transformDirection(this._walkerMesh.matrixWorld),t.multiplyScalar(10),t.add(e.point),this._mouseHelper.lookAt(t)});i(this,"getIntersectsByMouseEvent",e=>{const t={x:e.clientX/this._container.offsetWidth*2-1,y:-(e.clientY/this._container.offsetHeight)*2+1};return this._raycaster.setFromCamera(t,this._camera),this._raycaster.intersectObjects(this._scene.children,!0)});i(this,"getPointedTattooIdFromIntersects",e=>{var t,o;return(o=(t=e.find(s=>this._tattooInfoMap.get(s.object.uuid)))==null?void 0:t.object)==null?void 0:o.uuid});i(this,"addTattoo",e=>{const t=e.id,o=new _,s=new T,[a,c]=P(e),h=new _(a,c,200),l=new w(new y(this._walkerMesh,o,s,h),new H({map:new ee(e)}));l.uuid=t,l.visible=!1;const f=new w(new y(this._walkerMesh,o,s,new _().copy(h)),new E({transparent:!0,opacity:.3}));f.visible=!1,this._scene.add(f,l),this._tattooInfoMap.set(e.id,{id:t,canvas:e,mesh:l,outlineMesh:f,size:h,orientation:s,position:o}),this.markTattooAsActive(t)});i(this,"markTattooAsActive",e=>{this.activeTattooId=e;const o=this._tattooInfoMap.get(e).outlineMesh;o.visible=!0,o.material.color.setHex(6591981)});i(this,"clearActiveTattoo",()=>{if(this.activeTattooId){const e=this._tattooInfoMap.get(this.activeTattooId);e.outlineMesh.visible=!1,this.activeTattooId=null}});i(this,"rotate",(e,t)=>{const o=this._tattooInfoMap.get(e);if(!o)return null;const s=new T().copy(o.orientation);s.z=t,this.updateTattooMesh(o,{orientation:s})});i(this,"scale",(e,t)=>{const o=this._tattooInfoMap.get(e);if(!o)return null;const[s,a]=P(o.canvas),c=new _(s*t,a*t,200);this.updateTattooMesh(o,{size:c})});i(this,"resize",()=>{this._camera.aspect=this._container.offsetWidth/this._container.offsetHeight,this._camera.updateProjectionMatrix(),this._renderer.setSize(this._container.offsetWidth,this._container.offsetHeight)});i(this,"setSkin",e=>{this._walkerMesh.material.color.setHex(e)});this._canvas=t,this._container=e,this._activeTattooIdChange=s,this.init().then(()=>{console.log("\u521D\u59CB\u5316\u5B8C\u6210"),this.bindEvent(),o()})}get activeTattooId(){return this._activeTattooId}set activeTattooId(e){this._activeTattooId=e,this._activeTattooIdChange(e)}}const g={tattooViewer:null},pe=I({key:"tattooFilesAtom",default:[]}),S=I({key:"loadingAtom",default:!1}),B=I({key:"editingTattooIdAtom",default:void 0});const me=({info:n})=>{const[e,t]=u.exports.useState(1),o=u.exports.useRef(null),[,s]=v(S),[a]=v(B);u.exports.useEffect(()=>{h()},[]);const c=u.exports.useMemo(()=>te.exports.debounce(d=>{var m;const p=Math.max(d,.1);(m=g.tattooViewer)==null||m.scale(n.id,p)},300),[n.id]);u.exports.useEffect(()=>{c(e)},[c,e]);const h=()=>{s(!0);const d=o.current,p=d.getContext("2d"),m=new Image,x=new FileReader;x.readAsDataURL(n.file),x.onload=k=>{var L;((L=k.target)==null?void 0:L.readyState)===FileReader.DONE&&(m.src=k.target.result,m.onload=()=>{d.width=m.width,d.height=m.height,p.drawImage(m,0,0),g.tattooViewer.addTattoo(d)}),s(!1)}},l=d=>{var p;(p=g.tattooViewer)==null||p.rotate(n.id,d)},f=A("tattoo-editor-wrapper",{editing:n.id===a});return M("div",{className:f,children:[r("canvas",{className:"tattoo",id:n.id,ref:o}),M("div",{className:"edit-panel",children:[r("div",{children:"\u6587\u4EF6\u540D"}),r("div",{className:"file-name",children:n.file.name}),r("div",{children:"\u65CB\u8F6C"}),r(oe,{defaultValue:0,min:-1*Math.PI*10,max:Math.PI*10,onChangeCommitted:(d,p)=>{l(p/10)}}),r("div",{children:"\u5C3A\u5BF8(\u500D\u6570)"}),r(b,{onClick:()=>{const d=e*1e4-.05*1e4;t(d/1e4)},children:r(se,{})}),M("span",{className:"scale-number",children:[" ",e," "]}),r(b,{onClick:()=>{const d=e*1e4+.05*1e4;t(d/1e4)},children:r(R,{})})]})]})};const fe=["fee3d4","ffdbac","f2ccb7","dfaa8b","d19477","bc644d"],_e=()=>{const[n,e]=u.exports.useState("ffdbac");return r("div",{className:"skin-editor",children:fe.map(t=>r("div",{onClick:()=>{var o;e(t),(o=g.tattooViewer)==null||o.setSkin(Number(`0x${t}`))},className:A("color-radio",{active:t===n}),style:{backgroundColor:`#${t}`}},t))})};function we(){const n=u.exports.useRef(null),e=u.exports.useRef(null),[t,o]=v(pe),[s,a]=v(S),[,c]=v(B);return u.exports.useEffect(()=>{a(!0),g.tattooViewer=new ue({container:n.current,canvas:e.current,onInitSuccess(){g.tattooViewer.resize(),a(!1)},activeTattooIdChange(h){c(h)}})},[]),M("div",{className:"main-container",children:[r(ie,{open:s,sx:{color:"#fff",zIndex:h=>h.zIndex.drawer+1},children:r(ae,{color:"inherit"})}),t.map(h=>r(me,{info:h},h.id)),r(_e,{}),M("label",{htmlFor:"upload-input",children:[r("input",{id:"upload-input",type:"file",accept:"image/*",onChange:h=>{const l=h.target.files[0];o([...t,{id:ne(),file:l}])}}),r(b,{className:"add-tattoo",variant:"contained",component:"span",children:r(R,{})})]}),r("div",{className:"canvas-wrapper",ref:n,children:r("canvas",{style:{width:"100%",height:"100%",display:"block"},ref:e})})]})}re.render(r(ce.StrictMode,{children:r(he,{children:r(we,{})})}),document.getElementById("root"));
